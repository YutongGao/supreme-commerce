/* Copyright Â© 2014-2018 Moxie Software. All Rights Reserved. Concierge Version: v1.4.1 */
!function(e){"use strict";function s(e){if(null===e)return null;try{var s=e.charAt(0);return"{"===s||"["===s||'"'===s?JSON.parse(e):e}catch(t){return O("JSON: StorageBridge unable to parse: ",e),""}}function t(){return!0}function r(e,s){var t=e.indexOf(s);return t>=0?e.splice(t,1):null}function n(){var e=JSON.stringify(Date.now());localStorage.setItem(k+"|update-time",e),I&&sessionStorage.setItem("ls-"+k+"|update-time",e)}function i(e){var s=e.indexOf("|");return s>0&&(e=e.slice(s+1)),e}function o(e){for(var s=[],t=e.length,r=0;r<t;r++)s[r]=i(e[r]);return s}function a(e,s,t){var r=e.getItem(s);return r!==t&&e.setItem(s,t),r}function l(e,s){for(var t,r=s.length,n=[],i=0;i<r;i++)t=s.key(i),0===t.indexOf(e)&&n.push(t);return n}function g(){var e,t=localStorage.getItem(k+"|update-time"),n=sessionStorage.getItem("ls-"+k+"|update-time"),g=!!t,u={ssUpdateTime:n,updateTime:t,ssUpdateTimeNumber:Number(n),updateTimeNumber:Number(t),shouldCopy:n&&(!t||Number(n)>Number(t))};if(O("Check to copy: "+JSON.stringify(u)),n){if(!t||Number(n)>Number(t)){O("Copying shared keys from session_storage into local_storage");var c=o(l(k+"|",localStorage));r(c,"client-keys"),r(c,"update-time");var f=sessionStorage.getItem("ls-"+k+"|client-keys");if(f){var d=s(f);for(e=0;e<d.length;e++){var m=i(d[e]);r(c,m);var S=sessionStorage.getItem("ls-"+k+"|"+m);a(localStorage,k+"|"+m,S)}for(a(localStorage,k+"|client-keys",f),e=c.length;e>0;e--)localStorage.removeItem(c[e-1])}g=!1}t&&Number(n)===Number(t)&&(g=!1)}return g}function u(e){for(var s=0;s<e.length;s++){var t=i(e[s]),r=localStorage.getItem(k+"|"+t);a(sessionStorage,"ls-"+k+"|"+t,r)}a(sessionStorage,"ls-"+k+"|client-keys",JSON.stringify(e)),n()}function c(e,t){var r,n,o,a,l,g=e?localStorage:sessionStorage;if(r=g.getItem(k+"|client-keys"))for(N[t]=n=s(r),o=0;o<n.length;o++)l=i(n[o]),e&&0===l.indexOf("ls-")||(e||"update-time"!==l)&&(a=g.getItem(k+"|"+l),h[t][l]=s(a))}function f(e,s){return e=e||{},s.requesterId&&(e.requesterId=s.requesterId),s.requestId&&(e.requestId=s.requestId),e.bridgeName="storage_bridge",e}function d(e){if(k)O('StorageBridge: initClient has already been invoked for "'+k+'"" event: "'+e.client+'"');else{k=e.client,I=e.shadowInSessionStorage||!1;var s=!1;I&&(s=g()),c(!0,"ls"),c(!1,"ss"),s&&u(N.ls)}return f({request:"initResponse",lsValue:h.ls,ssValue:h.ss},e)}function m(e,s){for(var t=l(e,s),r=t.length,n=0;n<r;n++)s.removeItem(t[n])}function S(e){var s=k+"|";return m(s,sessionStorage,"ss"),m(s,localStorage,"ls"),m("ls-"+s,sessionStorage,"ss"),N.ls=[],N.ss=[],a(sessionStorage,k+"|client-keys","[]"),a(localStorage,k+"|client-keys","[]"),I&&a(sessionStorage,"ls-"+k+"|client-keys","[]"),n(),f({request:"ack"},e)}function y(e){var s=k+"|"+e.key,t=e.persist?"ls":"ss",r=e.persist?localStorage:sessionStorage,i=JSON.stringify(e.value);if(a(r,s,i),N[t].indexOf(s)<0){N[t].push(s);var o=JSON.stringify(N[t]);a(r,k+"|client-keys",o),e.persist&&I&&a(sessionStorage,"ls-"+k+"|client-keys",o)}return e.persist&&(n(),I&&a(sessionStorage,"ls-"+e.client+"|"+e.key,i)),f({request:"ack"},e)}function v(e){var s=k+"|"+e.key,t=e.persist?"ls":"ss",r=e.persist?localStorage:sessionStorage;if(N[t].indexOf(s)>=0){N[t].splice(N[t].indexOf(s),1);var i=JSON.stringify(N[t]);a(r,k+"|client-keys",i),r.removeItem(s),e.persist&&(n(),I&&(a(sessionStorage,"ls-"+k+"|client-keys",i),sessionStorage.removeItem("ls-"+k+"|"+e.key)))}return f({request:"ack"},e)}function p(e){var s=e.data;if("string"==typeof s)try{s=JSON.parse(s)}catch(r){return void b("StorageBridge: handleRequest parsing error: ",r)}if(t(e.origin)&&q(s))try{switch(s.request){case"init":e.source.postMessage(JSON.stringify(J(d(s))),e.origin);break;case"clear":e.source.postMessage(JSON.stringify(J(S(s))),e.origin);break;case"store":e.source.postMessage(JSON.stringify(J(y(s))),e.origin);break;case"remove":e.source.postMessage(JSON.stringify(J(v(s))),e.origin)}}catch(n){b("StorageBridge.handleRequest: error: ",n),e.source.postMessage(JSON.stringify(J(f({error:{message:n.message,stack:n.stack}},s))),e.origin)}}var k="",N={ls:[],ss:[]},h={ls:{},ss:{}},I=!1,O=function(s){"undefined"!=typeof e.GoMoxie&&"undefined"!==e.GoMoxie.console?e.GoMoxie.console.log(s):"undefined"!=typeof e.console&&e.console.log(s)},b=function(e,s){O(e+s.stack?s.stack:s.message)},J=function(e){return e.signature="moxie_concierge",e},q=function(e){return"moxie_concierge"===e.signature};e.addEventListener?e.addEventListener("message",p,!1):e.attachEvent&&e.attachEvent("onmessage",p)}(window);